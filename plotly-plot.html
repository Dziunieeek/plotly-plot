<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="plotly-import.html">

<!--
Polymer element for the plotly.js library

Example:

  <plotly-plot data="[2, 3]">
  </plotly-plot>

@demo demo/index.html
-->

<dom-module id="plotly-plot">
  <template>
    <div id="plot"></div>
  </template>

  <script>
    Polymer({
      is: 'plotly-plot',

      properties: {
        data: {
          type: Array,
          reflectToAttribute: true,
          notify: true,
          observer: 'redraw',
          value: function () { return [{x: [], y: []}]; }
        },
        layout: {
          type: Object,
          reflectToAttribute: true,
          notify: true,
          observer: 'relayout',
          value: function () { return { height: 0, width: 0, title: '' }; }
        },
        config: {
          type: Object,
          reflectToAttribute: true,
          notify: true,
          observer: 'redraw',
          value: function () { return {}; }
        },
      },

      observers: [
        'redraw(data.*)',
        'redraw(layout.*)',
        'redraw(config.*)'
      ],

      // Life Cycle

      attached: function () {
        var plotlyReturnValue = Plotly.newPlot(
          this.$.plot, this.data, this.layout, this.config
        );

        // These event handlers need to be bound to variables because of
        // event binding and unbinding upon attach/detach/reattach
        this._onPlotlyClick = function (data) {
          this.fire('plotly-click', {data: data});
        }.bind(this);

        this._onPlotlyBeforehover = function (data) {
          return this.fire('plotly-beforehover', {data: data});
        }.bind(this);

        this._onPlotlyHover = function (data) {
          return this.fire('plotly-hover', {data: data});
        }.bind(this);

        this._onPlotlyUnhover = function (data) {
          return this.fire('plotly-unhover', {data: data});
        }.bind(this);

        // fire Polymer events in accordance with the plotly.js ones as well
        this.$.plot.on('plotly_click', this._onPlotlyClick);
        this.$.plot.on('plotly_beforehover', this._onPlotlyBeforehover);
        this.$.plot.on('plotly_hover', this._onPlotlyHover);
        this.$.plot.on('plotly_unhover', this._onPlotlyUnhover);

        return plotlyReturnValue;
      },

      detached: function () {
        // remove the attached Polymer events
        this.$.plot.removeListner('plotly_click', this._onPlotlyClick);
        this.$.plot.removeListner('plotly_beforehover', this._onPlotlyBeforeHover);
        this.$.plot.removeListner('plotly_hover', this._onPlotlyHover);
        this.$.plot.removeListner('plotly_unhover', this._onPlotlyUnHover);

        return;
      },

      // Refresh

      redraw: function () {
        // For some reason, this class gets removed and plotly.js complains
        this.toggleClass('js-plotly-plot', true, this.$.plot);

        this.$.plot.data = this.data;
        this.$.plot.layout = this.layout;
        this.$.plot.config = this.config;

        return Plotly.redraw(this.$.plot);
      },

      restyle: function (style, traceIndices) {
        var plotlyReturnValue = Plotly.restyle(this.$.plot, style, traceIndices);

        // Update the polymer properties to reflect the updated data
        this.data = this.$.plot.data;

        return plotlyReturnValue;
      },

      relayout: function (layoutUpdate) {
        var plotlyReturnValue = Plotly.relayout(this.$.plot, layoutUpdate);

        // Update the polymer properties to reflect the updated data
        this.layout = this.$.plot.layout;

        return plotlyReturnValue;
      },

      // Manipulate traces

      addTraces: function (traces, traceIndices) {
        var plotlyReturnValue = Plotly.addTraces(this.$.plot, traces, traceIndices);

        // Update the polymer properties to reflect the updated data
        this.data = this.$.plot.data;

        return plotlyReturnValue;
      },

      deleteTraces: function (traceIndices) {
        var plotlyReturnValue = Plotly.deleteTraces(this.$.plot, traceIndices);

        // Update the polymer properties to reflect the updated data
        this.data = this.$.plot.data;

        return plotlyReturnValue;
      },

      moveTraces: function (traceIndicesFrom, traceIndicesTo) {
        var plotlyReturnValue = Plotly.moveTraces(this.$.plot, traceIndicesFrom, traceIndicesTo);

        // Update the polymer properties to reflect the updated data
        this.data = this.$.plot.data;

        return plotlyReturnValue;
      },

    });
  </script>
</dom-module>
